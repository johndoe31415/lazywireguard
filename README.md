# lazywireguard
lazywireguard is a simple wrapper script that takes a simple JSON
representation of a network topology and creates configuration files (including
all keys) as well as a set of iptables routes for routing of traffic between
hosts. Note that generating all private keys on one server is not the most
secure way of doing this. This is merely intended to quickly get a Wireguard
VPN up and running the quick & dirty way.

## Example configuration
Take a look at the minimal configuration, `example_config_01_minimal.json`:

```json
{
    "topology": {
        "networks": [
            {
                "network": "172.16.0.0/24"
            }
        ],
        "domainname": "example-privlan.net"
    },
    "concentrator": {
        "name":     "concentrator",
        "hostname": "my-host.example.com"
    },
    "clients": [
        { "name": "ds9" },
        { "name": "reliant" },
        { "name": "deltaflyer" }
    ]
}
```

Here, you see a simple 172.16.0.0 VPN network in which the concentrator and
three clients will be placed it. By default, no routes between these hosts will
be allowed and the concentrator will also not route external networks.

Creation of the configuration files for this configuration can be done by simply:

```
$ ./lazywg example_config_01_minimal.json
```

This creates all keys for all hosts, e.g., the server config file in
`example-privlan.net/concentrator/wg0.conf`:

```
$ cat example-privlan.net/concentrator/wg0.conf 
# WireGuard configuration generated by https://github.com/johndoe31415/lazywireguard
# 2022-02-19 21:53:09
# Do not edit manually.

[Interface]
Address = 172.16.0.1/24
ListenPort = 51820
PrivateKey = GG2+BhY5dgL9BqIYB5f1EdED4ca0I3W4yPVDEOyda10=

# ds9
[Peer]
PublicKey = 816642HRAyat/LHOxdtulNybRakCnBlXpmx2q4I5ozc=
AllowedIPs = 172.16.0.2/32

# reliant
[Peer]
PublicKey = XHiU+dKHb9AI/kFA3uff1+GTqLL/Z4vx78r5c1DrJ2w=
AllowedIPs = 172.16.0.3/32

# deltaflyer
[Peer]
PublicKey = /2TsQQOy6k1EcKcKadXEKxFQcDe02rOBeu3HfUvu9Ew=
AllowedIPs = 172.16.0.4/32

```

It also creates client config files, like `example-privlan.net/deltaflyer/wg0.conf`:

```
$ cat example-privlan.net/deltaflyer/wg0.conf
# WireGuard configuration generated by https://github.com/johndoe31415/lazywireguard
# 2022-02-19 21:53:09
# Do not edit manually.

[Interface]
Address = 172.16.0.4/24
PrivateKey = qGJbEB/RdtWxIhrABJ0CLc83ooBYVl7anlBGlSL/om8=

[Peer]
Endpoint = my-host.example.com:51820
PublicKey = u/2UaXBXQm3p5e1+YMU3EjMJOqjdrTspwpBB94WinG8=
PersistentKeepalive = 60
```

## More advanced example
lazywg does not only support IPv4, but also IPv6 or operation where a tunnel
has IPv4 and IPv6 addresses. It also supports easy specification of which hosts
should be able to reach which other hosts and creates an iptables ruleset for
this purpose. This ruleset honors IPv4 and IPv6 requirements and uses the right
tool for the respective job (i.e., iptables vs. ip6tables).

Furthermore, hosts can be grouped together and a whole group route can be
easily created.  This is useful if you have multiple clients that belong to a
single entity and you want to allow all their auto-assigned addresses to be
able to reach specific hosts.

Lastly, you can specify external networks that should be routed through the
tunnel. The generated configuration will be such that the clients' default
route will be set to use them.

Note that in the routing setup you can use various placeholders:

  * A simple string references a host name. E.g., `foo -> bar` means host `foo`
    should be allowed to talk to host `bar`.
  * As asterisk `*` means "everwhere". E.g., `foo -> *` allows host foo to talk
    to all destinations.
  * A prefix `@` means "group". E.g., `@mygroup -> foo` allows all hosts in
    group "mygroup" to talk to host foo.
  * An exclamation mark `!` prefix means "literal address/network". E.g.,
    `@mygroup -> 1.2.3.4` allows all hosts in "mygroup" to talk to 1.2.3.4.

The arrows have also different meaning:

  * The single arrow `->` means "route on the tunnel interface
    unidirectionally, but route established/related connections back". For
    example, `foo -> bar` allows `foo` to establish a TCP connection to `bar` and
    those hosts will then be able to talk to each other bidirectionally, but `bar`
    would not be able to initiate that connection.
  * The double-sided arrow `<->` marks a bidirectional connection on the tunnel
    interface, i.e., in the above example `foo <-> bar` would mean either `foo`
    or `bar` could establish a connection to its respective peer.
  * The fat arrow is like the single arrow (e.g., => instead of -> or <=>
    instead of <->) but it limits traffic to not only the tunnel interface. For
    example, `foo -> *` means that host `foo` can reach everyone on the tunnel
    interface of the concentrator, but `foo => *` would mean foo can reach *any*
    destination whatsoever. So when you have an external network that you would
    like to allow routes to, you typically want to use this variant, such as
    `foo => 10.20.0.0/16` so that host `foo` can reach this external network (which
    is on some other interface on the concentrator).

A more complex example that showcases all functionality can be seen in
`example_config_05_extnet.json`:

```json
{
    "topology": {
        "networks": [
            {
                "network":      "172.16.0.0/24"
            },
            {
                "network":      "fd11:2233::0/64",
                "exclude": [
                    "fd11:2233::01",
                    [ "fd11:2233::03", "fd11:2233::05" ]
                ]
            }
        ],
        "domainname": "example-privlan.net",
        "routed": [
            "10.15.16.0/24",
            "fd99::0/64"
        ]
    },
    "concentrator": {
        "name":     "concentrator",
        "hostname": "my-host.example.com",
        "port":     51820
    },
    "clients": [
        {
            "name": "ds9",
            "address": [ "fd11:2233::01", "172.16.0.9" ]
        },
        {
            "name": "reliant",
            "address": "172.16.0.1"
        },
        {
            "name": "deltaflyer",
            "ifname": "wg8",
            "address": "fd11:2233::02"
        },
        { "name": "group01-host01", "group": "group01" },
        { "name": "group01-host02", "group": "group01" },
        { "name": "group01-host03", "group": "group01" },
        { "name": "group01-host04", "group": "group01" },
        { "name": "group01-host05", "group": "group01" },
        { "name": "group01-host06", "group": "group01" },
        { "name": "group01-host07", "group": "group01" },
        { "name": "group01-host08", "group": "group01" },
        { "name": "group01-host09", "group": "group01" },
        { "name": "group01-host10", "group": "group01" }
    ],
    "route": [
        "* -> ds9",
        "reliant <-> deltaflyer",
        "reliant -> @group01",
        "reliant => !10.15.16.9",
        "reliant <=> !10.15.16.10",
        "reliant => !fd99::1122"
    ]
}
```

This is the associated iptables ruleset that is generated:

```
$ cat example-privlan.net/concentrator/iptables.sh
#!/bin/bash
# * -> ds9
iptables -A FORWARD -i wg0 -o wg0 -d 172.16.0.9 -j ACCEPT -m comment --comment '* -> ds9'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.9 -j ACCEPT -m comment --comment 'only established: * -> ds9'
ip6tables -A FORWARD -i wg0 -o wg0 -d fd11:2233::1 -j ACCEPT -m comment --comment '* -> ds9'
ip6tables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s fd11:2233::1 -j ACCEPT -m comment --comment 'only established: * -> ds9'

# reliant <-> deltaflyer
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.3 -j ACCEPT -m comment --comment 'reliant <-> deltaflyer'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.3 -d 172.16.0.1 -j ACCEPT -m comment --comment 'reliant <-> deltaflyer'
ip6tables -A FORWARD -i wg0 -o wg0 -s fd11:2233::7 -d fd11:2233::2 -j ACCEPT -m comment --comment 'reliant <-> deltaflyer'
ip6tables -A FORWARD -i wg0 -o wg0 -s fd11:2233::2 -d fd11:2233::7 -j ACCEPT -m comment --comment 'reliant <-> deltaflyer'

# reliant -> @group01
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.4 -j ACCEPT -m comment --comment 'reliant -> @group01'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.4 -d 172.16.0.1 -j ACCEPT -m comment --comment 'only established: reliant -> @group01'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.5 -j ACCEPT -m comment --comment 'reliant -> @group01'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.5 -d 172.16.0.1 -j ACCEPT -m comment --comment 'only established: reliant -> @group01'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.6 -j ACCEPT -m comment --comment 'reliant -> @group01'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.6 -d 172.16.0.1 -j ACCEPT -m comment --comment 'only established: reliant -> @group01'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.7 -j ACCEPT -m comment --comment 'reliant -> @group01'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.7 -d 172.16.0.1 -j ACCEPT -m comment --comment 'only established: reliant -> @group01'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.8 -j ACCEPT -m comment --comment 'reliant -> @group01'
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -i wg0 -o wg0 -s 172.16.0.8 -d 172.16.0.1 -j ACCEPT -m comment --comment 'only established: reliant -> @group01'
iptables -A FORWARD -i wg0 -o wg0 -s 172.16.0.1 -d 172.16.0.10 -j ACCEPT -m comment --comment 'reliant -> @group01'
[...]
```

## License
GNU GPL-3.
